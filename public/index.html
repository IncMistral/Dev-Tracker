
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BM Project Tracker</title>
  <style>
    :root{
      --bg: #1e1e1e;
      --bg-elev: #2a2a2a;
      --bg-elev-2: #2f2f2f;
      --text: #f5f7fa;
      --text-muted: #cfd6dd;
      --border: rgba(255,255,255,0.12);
      --accent: #00acc1;
      --accent-600: #0793a4; /* hover */
      --accent-700: #067e8c; /* active */
      --success: #2ecc71;
      --danger: #e74c3c;
      --warn: #f39c12;

      --radius-sm: 0.375rem; /* 6px */
      --radius-md: 0.625rem; /* 10px */
      --shadow-1: 0 1px 2px rgba(0,0,0,0.35);
      --shadow-2: 0 6px 14px rgba(0,0,0,0.35);

      --gap-1: 0.25rem; /* 4px */
      --gap-2: 0.5rem;  /* 8px */
      --gap-3: 0.75rem; /* 12px */
      --gap-4: 1rem;    /* 16px */

      --fs-8: 0.5rem;     /* 8px */
      --fs-10: 0.625rem;  /* 10px */
      --fs-12: 0.75rem;   /* 12px */
      --fs-14: 0.875rem;  /* 14px */
      --fs-16: 1rem;      /* 16px */
    }

    /* Global font smoothing for crisper text on TVs */
    body, button, input, select, .dayLetter, .completion, .milestone-label, .milestone-date {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    /* ===== Overlay for logout state ===== */
        #screenOverlay {
      position: fixed;
      top: 48px; /* height of your #topBar */
      left: 0;
      width: 100%;
      height: calc(100% - 48px); /* cover only below header */
      backdrop-filter: blur(6px);
      background: rgba(0, 0, 0, 0.3);
      z-index: 900;
      display: none;
      pointer-events: all;
    }

    /* Layout */
    body {
      background:#2c2c2c; color:var(--text);
      font-family:Arial, sans-serif;
      margin:0; padding:0; height:100vh;
      display:flex; flex-direction:column;
      font-size: 16px; /* root for rems */
    }
    #topBar{
      display:flex; align-items:center; gap:0.75rem; padding:0.625rem 0.875rem;
      background: linear-gradient(180deg, #2a2a2a, #232323);
      border-bottom:1px solid var(--border);
    }
    #topBar .logo { height:2rem; width:auto; object-fit:contain; display:block; }
    #trackerWrapper { flex:1; position:relative; background:#1e1e1e; overflow:auto; min-height:50rem; }
    .absolute { position:absolute; white-space:nowrap; }

    #topBar-spacer {
      flex:1;  /* pushes the Login button to the far right */
    }

    
    /* Controls */
    button{
      margin:0.3125rem; padding:0.5rem 0.875rem;
      background:var(--accent); border:none; color:white; font-weight:bold; cursor:pointer;
      border-radius: var(--radius-sm); font-size: var(--fs-14);
      letter-spacing:.0125rem; box-shadow: var(--shadow-1);
      transition: background .12s ease, transform .06s ease, box-shadow .12s ease;
      outline:none;
    }
    button:hover{ background: var(--accent-600); }
    button:active{ background: var(--accent-700); transform: translateY(0.0625rem); }
    button:focus-visible{ box-shadow: 0 0 0 0.125rem rgba(0,172,193,.25), 0 0 0 0.25rem rgba(0,172,193,.25); }
    button[disabled]{ opacity:.6; cursor:not-allowed; box-shadow:none; }

    input, select{
      padding:0.375rem; margin:0.3125rem auto; font-size:var(--fs-14); width:90%; display:block;
      background:#222; color:var(--text); border:1px solid var(--border);
      border-radius: var(--radius-sm); outline:none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    input:focus, select:focus{ border-color: var(--accent); box-shadow: 0 0 0 0.125rem rgba(0,172,193,.15); }

    /* Bars & milestones */
    .bar { position:absolute; background:#cec4c4; }
    .bar-fill { position:absolute; background:var(--accent); }
    .bar-border { position:absolute; border:1px solid rgba(255,255,255,0.18); box-sizing:border-box; pointer-events:none; }
    .milestone { position:absolute; background:var(--warn); pointer-events:none; }
    .milestone.complete { background:var(--success); }
    .milestone.overdue { background:var(--danger); }
    .milestone-label, .milestone-date{ font-size: var(--fs-8); text-shadow: 0 1px 1px rgba(0,0,0,.4); }
    .milestone-label {
      font-size: var(--fs-8);
      color: #fff;
      font-weight: 600;
    }

    .milestone-date {
      font-size: var(--fs-8);
      color: #ccc;
    }

    .completion { position:absolute; font-size:var(--fs-12); color:white; white-space:nowrap; pointer-events:none; }
    .weekendHatch { background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 2px, transparent 2px, transparent 6px); pointer-events:none; }

    .dayLetter {
      position:absolute;
      font-size: var(--fs-10); /* ~10px */
      color:rgba(255,255,255,0.85);
      transform:translate(-50%,-50%);
      pointer-events:none;
      line-height:1.1;
      text-align:center;
      white-space:nowrap;
    }

    .tick { pointer-events:none; }
    .draggable { cursor: grab; }
    .dragging, .draggable:active { cursor: grabbing; }
    .teamRole { font-weight:bold; font-size: var(--fs-12); text-decoration: underline; text-underline-offset: 0.1875rem; text-decoration-thickness: 0.125rem; }

    /* Modals */
    .modal { display:none; position:fixed; inset:0; justify-content:center; align-items:center; z-index:2000; }
    .modalContent {
      background: var(--bg-elev-2);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-2);
      border-radius: var(--radius-md);
      padding:1.25rem; color:white; width:35rem; max-width:90vw; text-align:center;
    }
    .modalContent h4 { margin:0.875rem 0 0.5rem; }

    /* Lists */
    #milestoneList,#memberList,#groupProjectList { margin-top:0.625rem; text-align:left; max-height:13.75rem; overflow-y:auto; }
    #milestoneList div, #memberList div {
      margin:0.25rem 0; padding:0.375rem 0.5rem; background:#343434;
      display:flex; justify-content:space-between; align-items:center; gap:0.5rem;
      border-radius: var(--radius-sm); border:1px solid var(--border);
    }
    
    #milestoneList div {
      padding: 0.1rem 0.1rem;  /* thinner top/bottom padding */
      font-size: 0.8rem;         /* optional: smaller text inside */
    }

    /* Shrink milestone row buttons */
      #milestoneList button {
      padding: 2px 6px;      /* less inside spacing */
      font-size: 0.75rem;    /* slightly smaller text */
      line-height: 1rem;     /* keeps button height tight */
      height: auto;          /* let padding control height */
    }


    #milestoneList span,#memberList span,#groupProjectList span { flex:1; }

    /* Project rows in group modal */
    #groupProjectList .proj-row {
      margin:0.25rem 0; padding:0.25rem 0.5rem; display:flex; align-items:center; gap:0.5rem;
      background:#2b2b2b; border:1px solid var(--border); border-radius: var(--radius-sm);
      box-shadow: var(--shadow-1); line-height:1.2;
    }
    #groupProjectList .proj-row:hover { background:#313131; box-shadow:0 2px 6px rgba(0,0,0,0.55); }
    #groupProjectList .proj-row span { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #groupProjectList .proj-row input[type="checkbox"] { width:1rem; height:1rem; margin-left:0.5rem; }

    /* Group background card */
    .group-card{
      position:absolute; left:1rem;
      background:#2b2b2b; border:1px solid var(--border); border-radius: var(--radius-md);
      box-shadow: var(--shadow-2);
      pointer-events:none;
      transition:box-shadow .12s ease, transform .12s ease, background .12s ease;
    }
    .group-card.is-hovered{ background:#313131; box-shadow: 0 12px 24px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,0.12) inset; transform:translateY(-1px); }

    /* Clickable labels */
    .clickable { cursor:pointer; }
    .clickable:focus-visible{ outline: 2px solid rgba(0,172,193,.6); outline-offset:2px; }

    /* Scrollbars */
    #trackerWrapper::-webkit-scrollbar{ height:0.625rem; width:0.625rem; }
    #trackerWrapper::-webkit-scrollbar-thumb{ background:#3b3b3b; border-radius:0.5rem; border:0.125rem solid #1f1f1f; }
    #trackerWrapper::-webkit-scrollbar-track{ background:#1f1f1f; }

    /* Utilities */
    .sr-only { position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    body.dragging{ user-select:none; }

    @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation:none !important; } }

body {
  transform: scaleY(1.0);
  transform-origin: top center;
}

/* Extra spacing for compiled report */
#reportContent h2 {
  margin: 0.5rem 0 0.25rem;
  font-size: 1.4rem;
}
#reportContent h3 {
  margin: 0.5rem 0 0.25rem;
  font-size: 1.2rem;
}
#reportContent div {
  margin-bottom: 0.75rem;
}
#reportContent table {
  background: #2b2b2b;
  border: 1px solid #444;
  border-collapse: collapse;
  width: 100%;
}
    .row { display: flex; gap: 0.5rem; }

  </style>
</head>
<body>

<div id="screenOverlay"></div>
<div id="topBar">
  <img src="./Mistral_Logo.jpg" alt="Mistral Inc. logo" class="logo" />
  <button id="btnNewGroup" aria-label="+ New Group">+ New Group</button>

<div id="topBar-spacer"></div>
  <button id="btnLogin" aria-label="Login">Login</button>
  <button id="btnEditUser" style="display:none;" aria-label="Edit Users">Edit User</button>
</div>

  <div id="trackerWrapper" aria-live="polite" role="region" aria-label="Project timelines"></div>

  <!-- Group Modal -->
  <div id="groupModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="groupModalTitle">
    <div class="modalContent">
      <h3 id="groupModalTitle">EDIT GROUP</h3>
      <div style="position: relative; display: inline-block; width: 100%;">
  <input type="text" id="groupNameInput"
         placeholder="Group name"
         style="width: 60%; padding-right: 3.5rem;" />
  <button id="btnApplyGroupName"
          style="position: absolute; right: 0.25rem; top: 38%; transform: translateY(-50%);
                 height: 70%; font-size: 0.75rem; padding: 0 0.5rem;">
    Apply
  </button>
</div>
       <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; margin-top:0.75rem;">
        <button id="btnGroupEditTeam">Edit Team</button>
        <button id="btnGroupDelete" class="danger">Delete Group</button>
      </div>

      <h4 style="display:flex; align-items:center; justify-content:center; gap:0.5rem;">
        GROUP PROJECTS
        <button id="btnGroupNewProject" title="Add Project" style="padding:0 0.5rem; font-size:0.8rem;">+</button>
      </h4>
      <div id="groupProjectList"></div>

      <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; margin-top:0.75rem;">
      <button id="btnGroupClose">Close</button>
      </div>
    </div>
  </div>

<!-- Login Modal -->
<div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
  <div class="modalContent">
    <h3 id="loginModalTitle">LOGIN</h3>
    
    <input type="text" id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />

    <div style="margin-top:0.75rem; display:flex; justify-content:center; gap:0.5rem;">
      <button id="btnLoginSubmit">Login</button>
      <button id="btnLoginCancel">Cancel</button>
    </div>
  </div>
</div>

  <!-- Project Modal -->
  <div id="projectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="projectModalTitle">
    <div class="modalContent">
      <h3 id="projectModalTitle">EDIT PROJECT</h3>
      <input type="text" id="projectNameInput" placeholder="Project name" />
            <div class="row">
        <input type="date" id="projectStartDate" placeholder="Project Start Date" />
        <input type="date" id="projectCompletionDate" placeholder="Project Completion Date" />
      </div>
       <h4>Milestones</h4>
      <div id="milestoneList"></div>
      <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; margin-top:0.75rem;">
        <button id="btnProjAddMilestone">Add Milestone</button>
      </div>

      <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; margin-top:0.75rem;">
        <button id="btnProjSave">Save</button>
        <button id="btnProjClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Milestone Modal -->
  <div id="milestoneModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="milestoneModalTitle">
    <div class="modalContent">
      <h3 id="milestoneModalTitle">EDIT MILESTONE</h3>
      <input type="text" id="milestoneNameInput" placeholder="Milestone name" />
      <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap;">
        <input type="date" id="milestoneStartDate" />
      </div>
      <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; margin-top:0.75rem;">
        <button id="btnMsSave">Save</button>
        <button id="btnMsClose">Close</button>
        <button id="btnMsDelete" class="danger">Delete</button>
      </div>
    </div>
  </div>

<!-- Team Modal -->
<div id="teamModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="teamModalTitle">
  <div class="modalContent">
    <h3 id="teamModalTitle">EDIT TEAM</h3>

    <input type="text" id="roleInput" placeholder="Enter role" aria-label="Enter role" />
    <input type="text" id="memberName" placeholder="Enter name" />

    <!-- Add Member button centered above the list -->
    <div style="margin-top:0.75rem; display:flex; justify-content:center; gap:0.5rem;">
      <button id="btnTeamSave">Add Member</button>
      <button id="btnTeamApply" style="display:none;">Apply Edit</button>
    </div>

    <!-- Team members will be listed here -->
    <div id="memberList"></div>

    <!-- Cancel button centered at the bottom -->
    <div style="margin-top:1rem; display:flex; justify-content:center;">
      <button id="btnTeamClose">Close</button>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editUserModalTitle">
  <div class="modalContent">
    <h3 id="editUserModalTitle">EDIT USERS</h3>

    <input type="text" id="newUsername" placeholder="New username" />
    <input type="password" id="newPassword" placeholder="New password" />
    <select id="newRole">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>

    <div style="margin-top:0.75rem; display:flex; justify-content:center; gap:0.5rem;">
      <button id="btnAddUser">Add User</button>
      <button id="btnCloseEditUser">Close</button>
    </div>

    <div id="userList" style="margin-top:1rem; text-align:left;"></div>
  </div>
</div>

<script>
'use strict';

async function showLogs() {
  try {
    const res = await fetch("/api/logs");
    const logs = await res.json();
    console.table(logs);
  } catch (err) {
    console.error("Failed to fetch logs from server:", err);
  }
}

  /* ===================== OFFLINE CONSTANTS ===================== */
  const STORAGE_KEY = 'bm-tracker:v1';
  const VIEW_KEY    = 'bm-tracker:viewstate:v1';

  /* ===================== STATE (offline) ===================== */
  let groups = []; 
  let logs = [];                      
  let contextTarget = null;              
  let editingMilestoneIndex = null;      
  let editingMemberIndex = null;
  let projectBarRegions = [];
  let currentUser = null;   // { username, role }
  // Restore currentUser from localStorage if available
const savedUser = localStorage.getItem("bm-currentUser");
if (savedUser) {
  try {
    currentUser = JSON.parse(savedUser);
  } catch (e) {
    console.warn("Failed to parse saved user:", e);
    currentUser = null;
  }
}
         
  /* ===================== LIGHT DOM HELPERS ===================== */
  const $  = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  function el(tag, cls, text){
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (text != null) n.textContent = text;
    return n;
  }

  /* ===================== SERVER STORAGE ===================== */
async function saveData() {
  try {
    const res = await fetch("/api/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ groups, logs })
    });
    if (!res.ok) throw new Error("Save failed");
    console.log("✅ Data saved to server");
  } catch (e) {
    console.warn("Save failed:", e);
  }
}
 
async function loadFromServer() {
  try {
    const res = await fetch("/api/data");
    if (!res.ok) throw new Error("Load failed");
    const data = await res.json();
    if (data && Array.isArray(data.groups) && Array.isArray(data.logs)) {
      groups = data.groups;
      logs = data.logs;
      return true;
    }
  } catch (e) {
    console.warn("Server load failed:", e);
  }
  return false;
}


window.addEventListener("DOMContentLoaded", async () => {
  const loaded = await loadFromServer();
  if (!loaded) {
    groups = [];
  }
  render();
});


  /* ===================== DATE / TIMELINE ===================== */
  function parseLocalDate(yyyy_mm_dd) {
  const [y, m, d] = yyyy_mm_dd.split('-').map(Number);
  return new Date(y, m - 1, d);
}
function addDaysLocal(date, days) {
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  d.setDate(d.getDate() + days);
  return d;
}
function endOfDay(date) {
  const d = new Date(date);
  d.setHours(23, 59, 59, 999);
  return d;
}
/* ===================== LOGGING ===================== */
function addLogEntry(groupName, type, details) {
  // Default group name if missing/blank
  const safeGroup = groupName && groupName.trim() ? groupName : "UnknownGroup";

  logs.push({
    ts: Date.now(),
    date: new Date().toISOString().split("T")[0],
    group: safeGroup,
    user: currentUser?.username || "unknown",
    type,
    details
  });

  saveData(); // persist immediately
}


/* ===================== DAILY LOG COMPILER ===================== */
function compileDailyLogs() {
  if (!logs.length) return;

  // Normalize group names: fallback if not found
  logs.forEach(log => {
    if (!log.group || !groups.find(g => g.name === log.group)) {
      log.group = "UnknownGroup";
    }
  });

  // Build a new structure grouped by group/date
  const compiled = {};
  logs.forEach(log => {
    const key = `${log.group}:${log.date}`;
    if (!compiled[key]) compiled[key] = [];
    compiled[key].push(log);
  });


  // Replace localStorage approach with server persistence
  console.log("📦 Compiled logs ready:", compiled);

  // Persist to server
  saveData();
}

  const BAR_HEIGHT = 24, GAP = 25, LEFT_MARGIN = 200;
  const roleColors = { TEAM_LEAD:"orange", WELDER:"lightblue", INSTALLER:"limegreen", QC:"violet" };
  // Per-group zoom settings, default 15 days
  let projectZoomLevels = {};
  const DAY_MS = 24*60*60*1000;

  /* ===================== PROJECT VIEW-STATE (OFFLINE) ===================== */
  // Unique key for a project (group + project fields)
  function makeProjKey(groupName, p) {
    return [groupName || "", p?.name || "", p?.startDate || "", p?.completionDate || ""].join("§");
  }
  let projectViewState = loadViewState();

  function keyFor(gi, pi) {
    const g = groups[gi]; const p = g?.projects?.[pi];
    return g && p ? makeProjKey(g.name, p) : null;
  }

  function getOffset(gi, pi) {
    const g = groups[gi];
    const p = g?.projects?.[pi];
    if (p && Number.isFinite(p.offsetDays)) {
      return p.offsetDays; // prefer value on the project if present
    }
    const k = keyFor(gi, pi);
    return (k && Number.isFinite(projectViewState[k])) ? projectViewState[k] : 0;
  }

  function setOffset(gi, pi, v) {
  const k = keyFor(gi, pi);
  if (!k) return;
  projectViewState[k] = v;
  if (groups[gi] && groups[gi].projects && groups[gi].projects[pi]) {
    groups[gi].projects[pi].offsetDays = v;
  }
  saveViewState();
  saveData();   // ✅ auto-save
}

  /* ===================== DRAG / PAN (OFFLINE) ===================== */
  let dragState = null;

  function startDrag(e, gi, pi, barW, totalDays){
  const zoomDays = projectZoomLevels[`${gi}-${pi}`] || 15;  // ✅ per-project zoom
  const viewportDays = Math.min(totalDays, zoomDays);
  const maxOffset = Math.max(0, totalDays - viewportDays);
  const cellW = barW / viewportDays;

  dragState = {
    gi, pi,
    startX: e.clientX,
    initOffset: Math.min(getOffset(gi,pi), maxOffset),
    cellW, maxOffset
  };
  document.body.classList.add('dragging');
  e.preventDefault();
}

  function onMouseMove(e){
    if (!dragState) return;
    const dx = e.clientX - dragState.startX;
    const deltaDays = Math.round(-dx / dragState.cellW);
    let newOffset = dragState.initOffset + deltaDays;
    newOffset = Math.max(0, Math.min(dragState.maxOffset, newOffset));
    if (newOffset !== getOffset(dragState.gi, dragState.pi)) {
      setOffset(dragState.gi, dragState.pi, newOffset);
      render();
    }
  }
  function endDrag(){
    if (!dragState) return;
    dragState = null;
    document.body.classList.remove('dragging');
  }
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('mouseleave', endDrag);

  function fmtMilestoneDate(iso) {
    const d = parseLocalDate(iso);
    const M = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${M[d.getMonth()]}/${String(d.getDate()).padStart(2,"0")}`;
  }

  /* ===================== GROUP CARD HOVER TRACKING ===================== */
  let groupCardRegions = [];
  let groupHoverHandlersAttached = false;
  function attachGroupHoverHandlers(){
    const wrapper = document.getElementById('trackerWrapper');
    if (!wrapper || groupHoverHandlersAttached) return;

    wrapper.addEventListener('mousemove', (e) => {
      const r = wrapper.getBoundingClientRect();
      const x = e.clientX - r.left + wrapper.scrollLeft;
      const y = e.clientY - r.top  + wrapper.scrollTop;

      let active = null;
      for (const region of groupCardRegions){
        if (x >= region.x1 && x <= region.x2 && y >= region.y1 && y <= region.y2){
          active = region; break;
        }
      }
      groupCardRegions.forEach(region =>
        region.el.classList.toggle('is-hovered', region === active)
      );
    });

    wrapper.addEventListener('mouseleave', () => {
      groupCardRegions.forEach(region => region.el.classList.remove('is-hovered'));
    });

    groupHoverHandlersAttached = true;
  }

  /* ===================== RENDER TIMELINE ===================== */
function render() {
  const wrapper = document.getElementById("trackerWrapper");
  if (!wrapper) return;
  wrapper.innerHTML = "";
  let y = 48;

  groupCardRegions = [];
  attachGroupHoverHandlers();
  projectBarRegions = [];


  groups.forEach((g, gi) => {
    const sidePad = 15;     // match original
    const labelColWidth =100;    // match original
    const labelGutter = 10;
    const barXBase = sidePad + labelColWidth + labelGutter;

    // group background card (aligned to sidePad)
    const groupStartY = y - 45;
    const card = document.createElement('div');
    card.className = 'group-card';
    card.style.left   = sidePad + 'px';
    card.style.top    = groupStartY + 'px';
    card.style.width  = (wrapper.clientWidth - sidePad * 2) + 'px';
    card.style.height = '1px';
    wrapper.appendChild(card);

    // team ribbon (unchanged)
    const teamContainer = document.createElement("div");
    teamContainer.className = "absolute";
    teamContainer.style.left = "50%";
    teamContainer.style.top = (y - 40) + "px";
    teamContainer.style.transform = "translateX(-50%)";
    teamContainer.style.display = "flex";
    teamContainer.style.gap = "16px";
    (g.teamMembers || []).forEach((member) => {
      const box = document.createElement("div");
      box.style.display = "flex";
      box.style.flexDirection = "column";
      box.style.alignItems = "center";
      box.style.minWidth = "90px";
      box.style.gap = "8px";

      const roleEl = document.createElement("div");
      roleEl.className = "teamRole";
      roleEl.style.color = (roleColors[member.role] || "gray");
      roleEl.textContent = member.role;

      const nameEl = document.createElement("div");
      nameEl.style.color = "white";
      nameEl.style.fontSize = "0.75rem";
      nameEl.textContent = member.name;

      box.appendChild(roleEl);
      box.appendChild(nameEl);
      teamContainer.appendChild(box);
    });
    wrapper.appendChild(teamContainer);
  
// group label 
const groupLabel = document.createElement("span");
groupLabel.className = "absolute clickable";
groupLabel.style.left = sidePad + "px";          // 👈 label’s X position
groupLabel.style.top = (y - 40) + "px";          // 👈 label’s Y position
groupLabel.style.fontWeight = "700";
groupLabel.style.fontSize = "1rem";
groupLabel.style.color = "yellow";
groupLabel.textContent = g.name;
groupLabel.setAttribute("role", "button");
groupLabel.setAttribute("tabindex", "0");
groupLabel.setAttribute("aria-label", `Edit group ${g.name}`);
groupLabel.setAttribute("aria-controls", "groupModal");
groupLabel.addEventListener("click", () => openGroupModal(gi));
groupLabel.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    openGroupModal(gi);
  }
});
wrapper.appendChild(groupLabel);

// compile button (independent absolute positioning)
if (currentUser?.role === "admin") {
  const compileBtn = document.createElement("button");
  compileBtn.textContent = "Compile";

compileBtn.onclick = () => {
  compileDailyLogs();
  const reportHTML = showReportPage(g); // this already returns your compiled HTML

  const newTab = window.open('', '_blank');
  if (!newTab) {
    alert('Pop-up blocked! Please allow pop-ups for this site.');
    return;
  }

newTab.document.write(`
  <!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8" />
      <title>Compiled Report</title>
      <style>
        body { background:#1e1e1e; color:#f5f7fa; font-family:Arial,sans-serif; margin:0; padding:1rem; }
        h2,h3,h4 { margin:0.5rem 0; }
        table { border-collapse:collapse; margin:0.5rem 0 1.5rem 0; width:100%; }
        th,td { border:1px solid rgba(255,255,255,0.2); padding:0.15rem 0.5rem; text-align:left; font-size:0.75rem; }
        th { background:#2a2a2a; }
        select, button { margin:0.5rem 0.25rem; padding:0.25rem 0.5rem; }
      </style>
    </head>
    <body>
      <!-- Original compiled report -->
      <div id="reportContent">${reportHTML}</div>

      <!-- Divider -->
      <hr />

      <!-- Daily logs controls -->
<div>
  <label for="logDropdown">Daily Logs:</label>
  <select id="logDropdown"></select>
  <button id="btnViewLogs">View Logs</button>
  <button id="btnDeleteLogs" class="danger">Delete Logs</button>
  <button id="btnExportLogs">Export to Excel</button>
</div>


      <!-- Daily logs output -->
      <div id="logContent" style="margin-top:1rem;"></div>

      <script>
        // The group name is baked into this page
        const groupName = "${g.name}";
          // Inject logs into this new tab
        const logs = ${JSON.stringify(logs)};


        // Populate the dropdown with this group's log index

// Populate the dropdown with available log dates (requires groupName)
// Populate the dropdown with available log dates (requires groupName)
function refreshLogDropdown(groupName) {
  const index = Array.from(new Set(
    logs
      .filter(l => l.group === groupName || l.group === "UnknownGroup")
      .map(l => l.date)
  )).sort();

  const dd = document.getElementById("logDropdown");
  dd.innerHTML = index
    .map(function(date) {
      return '<option value="' + date + '">' + date + '</option>';
    })
    .join('');
}

// Render logs for a given date
function viewCompiledLogs(date) {
const logsForDate = logs.filter(l => {
  // Normalize group match: allow missing or stale names
  return (
    (!l.group || l.group === groupName || l.group === "UnknownGroup") &&
    l.date === date
  );
}).sort((a, b) => a.ts - b.ts);

  const container = document.getElementById("logContent");
  if (!logsForDate.length) {
    container.innerHTML = "<p><em>No logs for " + date + "</em></p>";
    return;
  }

  let html = "<h2>Logs for " + date + "</h2>";
  html += "<table><tr><th>Time</th><th>User</th><th>Type</th><th>Details</th></tr>";

  logsForDate.forEach(function(l) {
    const time = new Date(l.ts).toLocaleTimeString();
    const d = l.details || {};
    let detailText = "";

    switch (l.type) {
      case "login": detailText = "User " + (d.username || l.user) + " logged in"; break;
      case "logout": detailText = "User " + (d.username || l.user) + " logged out"; break;
      case "group-create": detailText = "Group created: " + (d.name || ""); break;
      case "group-delete": detailText = "Group deleted: " + (d.name || ""); break;
      case "project-create": detailText = "Project created: " + (d.name || ""); break;
      case "project-delete": detailText = "Project deleted: " + (d.name || ""); break;
      case "milestone-add": detailText = "Milestone added: " + (d.label || ""); break;
      case "milestone-edit": detailText = "Milestone edited: " + (d.label || ""); break;
      case "milestone-delete": detailText = "Milestone deleted: " + (d.label || ""); break;
      default: detailText = JSON.stringify(d);
    }

    html += "<tr>" +
              "<td>" + time + "</td>" +
              "<td>" + (l.user || "unknown") + "</td>" +
              "<td>" + l.type + "</td>" +
              "<td>" + detailText + "</td>" +
            "</tr>";
  });

  html += "</table>";
  container.innerHTML = html;
}

        let logsVisible = false;
        let currentDate = null;

        document.getElementById("btnViewLogs").onclick = () => {
          const dd = document.getElementById("logDropdown");
          if (!dd || !dd.value) return;

          const date = dd.value;
          const container = document.getElementById("logContent");

          if (!logsVisible || currentDate !== date) {
            // Show logs (or switch to a new date)
            viewCompiledLogs(date);
            logsVisible = true;
            currentDate = date;
            document.getElementById("btnViewLogs").textContent = "Hide Logs";
          } else {
            // Collapse logs
            container.innerHTML = "";
            logsVisible = false;
            currentDate = null;
            document.getElementById("btnViewLogs").textContent = "View Logs";
          }

          // Populate the dropdown with available log dates (requires groupName)
async function refreshLogDropdown(groupName) {
  try {
    // Always pull fresh logs from the backend
    const res = await fetch("/api/logs");
    const allLogs = await res.json();

    const dates = Array.from(new Set(
      allLogs
        .filter(l => l.group === groupName || l.group === "UnknownGroup")
        .map(l => l.date)
    )).sort();

    const dd = document.getElementById("logDropdown");
    dd.innerHTML = dates
      .map(date => '<option value="' + date + '">' + date + '</option>')
      .join('');
  } catch (err) {
    console.error("Failed to refresh dropdown:", err);
  }
}
           // Delete logs for the selected date (with password protection)
            document.getElementById("btnDeleteLogs").onclick = () => {
              const dd = document.getElementById("logDropdown");
              if (!dd || !dd.value) return;

              const date = dd.value;

              // ✅ Ask for password
              const password = prompt("Enter password to delete logs:");
              if (password !== "guest820") {
                alert("Incorrect password. Logs were not deleted.");
                return;
              }

              if (!confirm("Are you sure you want to delete all logs for " + date + "?")) return;

await fetch("/api/logs/" + encodeURIComponent(groupName) + "/" + encodeURIComponent(date), {
  method: "DELETE"
});

              refreshLogDropdown(groupName);
              document.getElementById("logContent").innerHTML = ""; // Clear display
          }   
        };
        // Init dropdown
        refreshLogDropdown(groupName);
        // Export only the selected log date
document.getElementById("btnExportLogs").onclick = function () {
  var dd = document.getElementById("logDropdown");
  if (!dd || !dd.value) {
    alert("Please select a log date to export.");
    return;
  }
  var date = dd.value;

  var logsForDate = logs.filter(l =>
  (l.group === groupName || l.group === "UnknownGroup") &&
  l.date === date
);

var logsSorted = logsForDate.sort((a, b) => a.ts - b.ts);


  if (!logs.length) {
    alert("No logs available for " + date);
    return;
  }

  var csv = "Time,User,Type,Details\\n";
  for (var i = 0; i < logs.length; i++) {
    var l = logs[i];
    var time = new Date(l.ts).toLocaleString();
    var user = l.user || "";
    var type = l.type || "";
    var details = "";
    try {
      details = (type === "invalid-login")
        ? ("Invalid login attempt by user: " + (((l.details && l.details.attemptedUser) || "(blank)")).toString().replace(/"/g, "''"))
        : JSON.stringify(l.details).replace(/"/g, "''");
    } catch (e) {}
    csv += time + "," + user + "," + type + "," + details + "\\n";
  }


  var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  var url = URL.createObjectURL(blob);
  var link = document.createElement("a");
  link.href = url;
  link.download = groupName + "_" + date + "_logs.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

      <\/script>
    </body>
  </html>
`);

  newTab.document.close();

  // 🔄 Also push the current in-memory data immediately
  if (newTab.renderReport) {
    newTab.renderReport(g);
  }
};


// 🔧 manual styling and positioning relative to timeline left edge
compileBtn.style.position = "absolute";
compileBtn.style.left = (sidePad + 150) + "px";  // 👈 adjust this number to set distance from left edge
compileBtn.style.top = (y - 42) + "px";          // 👈 adjust this number to align vertically with group label
compileBtn.style.fontSize = "0.7rem";
compileBtn.style.padding = "2px 6px";
compileBtn.style.cursor = "pointer";

wrapper.appendChild(compileBtn);
}

(g.projects || []).forEach((p, pi) => {
  // project name
  const projName = document.createElement("span");
  projName.className = "absolute";
  projName.style.left = sidePad + "px";
  projName.style.top = (y + BAR_HEIGHT/2 - 10) + "px";
  projName.style.width = labelColWidth + "px";
  projName.style.textAlign = "right";
  projName.style.fontSize = "1rem";
  projName.style.color = "white";
  projName.textContent = p.name;
  wrapper.appendChild(projName);

  // start date label
  if (p.startDate) {
    const startLabel = document.createElement("span");
    startLabel.className = "absolute";
    startLabel.style.left = (barXBase - 10) + "px";
    startLabel.style.top  = (y - 10) + "px";
    startLabel.style.transform = "translateX(-100%) translateY(-50%)";
    startLabel.style.fontSize = "0.5rem";
    startLabel.style.color = "#ccc";
    startLabel.textContent = p.startDate;
    wrapper.appendChild(startLabel);
  }

  const barX = barXBase;
  const barW = Math.max(200, wrapper.clientWidth - barX - sidePad);

  // bar + border
  const bar = document.createElement("div");
  bar.className = "bar";
  bar.style.left = barX + "px";
  bar.style.top = y + "px";
  bar.style.width = barW + "px";
  bar.style.height = BAR_HEIGHT + "px";
  bar.setAttribute('role','img');
  bar.setAttribute('aria-label', (p.startDate && p.completionDate)
    ? `Timeline for ${p.name} from ${p.startDate} to ${p.completionDate}`
    : `Timeline for ${p.name}`);
  wrapper.appendChild(bar);

  projectBarRegions.push({
    gi, pi,
    x1: barX,
    x2: barX + barW,
    y1: y,
    y2: y + BAR_HEIGHT
  });

  const border = document.createElement("div");
  border.className = "bar-border";
  border.style.left = barX + "px";
  border.style.top = y + "px";
  border.style.width = barW + "px";
  border.style.height = BAR_HEIGHT + "px";
  wrapper.appendChild(border);

  // fill, milestones, ticks
  if (p.startDate && p.completionDate) {
    const start = parseLocalDate(p.startDate);
    const end   = parseLocalDate(p.completionDate);

    const totalDays = Math.max(1, Math.ceil(
      (Date.UTC(end.getFullYear(), end.getMonth(), end.getDate()) -
       Date.UTC(start.getFullYear(), start.getMonth(), start.getDate())) / DAY_MS
    ));

    const zoomDays = projectZoomLevels[`${gi}-${pi}`] || 15;
    const viewportDays = Math.min(totalDays, zoomDays);
    const maxOffset = Math.max(0, totalDays - viewportDays);

    let offsetDays = Math.min(getOffset(gi,pi), maxOffset);
    setOffset(gi,pi, offsetDays);

    const visibleStart = addDaysLocal(start, offsetDays);
    const visibleEnd   = addDaysLocal(visibleStart, viewportDays);
    const cellW = barW / viewportDays;

    const now = new Date();
    const nowClamped = now < visibleStart ? visibleStart : (now > visibleEnd ? visibleEnd : now);
    const progress = Math.max(0, Math.min(1, (nowClamped - visibleStart) / (visibleEnd - visibleStart)));
    const fillW = barW * progress;

    const fill = document.createElement("div");
    fill.className = "bar-fill";
    fill.style.left = barX + "px";
    fill.style.top  = y + "px";
    fill.style.width = fillW + "px";
    fill.style.height = BAR_HEIGHT + "px";
    wrapper.appendChild(fill);

    // drag to pan
    if (totalDays > zoomDays) {
      const startDragHandler = (evt) => startDrag(evt, gi, pi, barW, totalDays);
      bar.classList.add('draggable');  bar.onmousedown = startDragHandler;
      fill.classList.add('draggable'); fill.onmousedown = startDragHandler;
    } else {
      bar.classList.remove('draggable');  bar.onmousedown = null;
      fill.classList.remove('draggable'); fill.onmousedown = null;
    }

// milestones FIRST
if (Array.isArray(p.milestones)) {
  p.milestones.forEach(m => {
    if (!m?.date) return;
    const d = parseLocalDate(m.date);
    if (d >= visibleStart && d <= visibleEnd) {
      const ratio = (d - visibleStart) / (visibleEnd - visibleStart);
      const mx = barX + ratio * barW;

      const ms = document.createElement("div");
      ms.className = "milestone";
      ms.style.left = mx + "px";
      ms.style.top  = y + "px";
      ms.style.width = cellW + "px";
      ms.style.height = BAR_HEIGHT + "px";

      // ✅ Auto status update based on due date unless completed
        if (m.date) {
        const dueDate = parseLocalDate(m.date);
        const today = new Date();

        if (m.status === "completed" || m.status === "completedLate") {
          // keep completed states as-is
        } else {
          if (today > endOfDay(dueDate)) {
            m.status = "overdue";   // 🔴
          } else {
            m.status = "incomplete"; // 🟠
          }
        }
      }


      // Apply colors based on status
      switch (m.status) {
        case 'incomplete':    ms.style.background = "orange"; break;   // 🟠 upcoming
        case 'overdue':       ms.style.background = "red"; break;      // 🔴 past due
        case 'completedLate': ms.style.background =
          "repeating-linear-gradient(45deg, red, red 4px, limegreen 4px, limegreen 8px)";
          break;
        case 'completed':     ms.style.background = "limegreen"; break; // 🟢 completed
        default:
          ms.style.background = "orange";
          m.status = "incomplete";
      }
      wrapper.appendChild(ms);

      // Label + date
      const labelWrap = document.createElement("div");
      labelWrap.style.position = "absolute";
      labelWrap.style.left = (mx + cellW / 2) + "px";
      labelWrap.style.top  = (y + BAR_HEIGHT + 4) + "px";
      labelWrap.style.transform = "translateX(-50%)";
      labelWrap.style.display = "flex";
      labelWrap.style.flexDirection = "column";
      labelWrap.style.alignItems = "center";
      labelWrap.style.gap = "2px";

      const lbl = document.createElement("div");
      lbl.className = "milestone-label";
      lbl.textContent = m.label || "";

      const dateLbl = document.createElement("div");
      dateLbl.className = "milestone-date";
      dateLbl.textContent = fmtMilestoneDate(m.date);

      labelWrap.appendChild(lbl);
      labelWrap.appendChild(dateLbl);
      wrapper.appendChild(labelWrap);
    }
  });
}

    // ticks + labels LAST
    for (let i = 0; i <= viewportDays; i++) {
      const curDate   = addDaysLocal(visibleStart, i);
      const dayOfWeek = curDate.getDay();
      const x = barX + (i / viewportDays) * barW;

      const tick = document.createElement("div");
      tick.className = "absolute tick";
      tick.style.left = x + "px";
      tick.style.top = y + "px";
      tick.style.width = "1px";
      tick.style.height = BAR_HEIGHT + "px";
      tick.style.background = "rgba(0,0,0,0.1)";
      wrapper.appendChild(tick);

      if (i < viewportDays) {
        const label = document.createElement("div");
        label.className = "dayLetter";
        label.style.left = (x + cellW / 2) + "px";
        label.style.top  = (y + BAR_HEIGHT / 2) + "px";

        const month = curDate.getMonth() + 1;
        const date  = curDate.getDate();
        const dow   = ['S','M','T','W','T','F','S'][dayOfWeek];

        label.innerHTML = `<div>${dow}</div><div style="font-size:0.75rem;">${month}/${String(date).padStart(2,"0")}</div>`;
        wrapper.appendChild(label);
      }

      if (i < viewportDays && (dayOfWeek === 0 || dayOfWeek === 6)) {
        const weekend = document.createElement("div");
        weekend.className = "absolute weekendHatch";
        weekend.style.left = x + "px";
        weekend.style.top  = y + "px";
        weekend.style.width = cellW + "px";
        weekend.style.height = BAR_HEIGHT + "px";
        wrapper.appendChild(weekend);
      }
    }

    // completion countdown
    if (p.completionDate) {
      const today = new Date();
      const end = new Date(p.completionDate);
      const diff = Math.max(0, Math.ceil((end - today) / (1000*60*60*24)));
      const comp = document.createElement("div");
      comp.className = "completion";
      comp.style.left = (barX + barW - 80) + "px";
      comp.style.top = (y - 16) + "px";
      comp.style.fontSize = "0.5rem";
      comp.textContent = `${p.completionDate} | T - ${diff}`;
      wrapper.appendChild(comp);
    }
  } // end if dates exist

  y += BAR_HEIGHT + GAP;
}); // ✅ closes projects.forEach

// group card expansion
const lastRowBottom = y - (BAR_HEIGHT + GAP);
const height = Math.max(0, (lastRowBottom + (BAR_HEIGHT + GAP) - groupStartY) + 12);
card.style.height = `${height}px`;

groupCardRegions.push({
  el: card,
  x1: card.offsetLeft, x2: card.offsetLeft + card.offsetWidth,
  y1: card.offsetTop,  y2: card.offsetTop + card.offsetHeight
});

y += 60; 
  }); 
} 
 
  /* ===================== GROUP MODAL: PROJECT LIST + ACTIONS ===================== */
  function renderGroupProjectList(gi) {
    const holder = document.getElementById("groupProjectList");
    if (!holder) return;

    // If creating a new group (no index yet), show helper text
    if (gi == null || gi === undefined) {
      holder.innerHTML =
        '<div class="proj-row" aria-disabled="true">' +
        '<span>No projects yet. Save this group, then click “New Project”.</span>' +
        "</div>";
      return;
    }

    const g = groups[gi];
    holder.innerHTML = "";

    (g.projects || []).forEach((p, pi) => {
      const row = document.createElement("div");
      row.className = "proj-row";

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.setAttribute("data-pi", String(pi));

      const name = document.createElement("span");
      name.textContent = p.name || "Untitled Project";

      const dates = document.createElement("span");
      dates.style.flex = "0 0 auto";
      dates.style.fontSize = "0.75rem";
      dates.style.color = "#cfd6dd";
      dates.textContent = `${p.startDate || ""} → ${p.completionDate || ""}`;

      const edit = document.createElement("button");
      edit.textContent = "Edit";
      edit.addEventListener("click", () => openProjectModal(gi, pi));

const del = document.createElement("button");
del.className = "danger";
del.textContent = "Delete";
del.addEventListener("click", () => {
  if (!confirm("Delete this project?")) return;

  // 🔥 Add a log entry for project delete (capture details before removing)
  const deletedProject = g.projects[pi];
  addLogEntry(g.name,"project-delete", {
    groupIndex: gi,
    projectIndex: pi,
    name: deletedProject?.name || "Untitled Project",
    startDate: deletedProject?.startDate || "",
    completionDate: deletedProject?.completionDate || ""
  });

  g.projects.splice(pi, 1);
  saveData();
  renderGroupProjectList(gi);
  render();
});

      row.appendChild(chk);
      row.appendChild(name);
      row.appendChild(dates);
      row.appendChild(edit);
      row.appendChild(del);
      holder.appendChild(row);
    });
  }
  
  /* ===================== GROUP MODAL: OPEN / SAVE / DELETE (OFFLINE) ===================== */
  function setGroupModalControlsDisabled(disabled){
    ["btnGroupEditTeam","btnGroupNewProject",
     "btnGroupSave","btnGroupDelete","btnGroupClose"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = !!disabled;
    });
  }

  function openTeamFromGroup(){
    if (!contextTarget || contextTarget.groupIndex == null) return;
    openTeamModal(contextTarget.groupIndex);
  }

  function newProjectFromGroup(){
    if (!contextTarget || contextTarget.groupIndex == null) return;
    const gi = contextTarget.groupIndex;
    contextTarget = { groupIndex: gi, projectIndex: null };
    openProjectModal(gi, null);
  }

function openGroupModal(gi) {
  // NEW: admin-only
  if (userRole !== "admin") { return; }

  contextTarget = { groupIndex: gi };
  const g = groups[gi];
  const nameInp = document.getElementById("groupNameInput");
  if (nameInp instanceof HTMLInputElement) nameInp.value = g?.name || "";
  renderGroupProjectList(gi);
  setGroupModalControlsDisabled(false);
  openModal("groupModal");
}

  function closeGroupModal() { closeModal("groupModal"); }

  // Create on Save if new; otherwise update name
function saveGroup() {
  const nameInp = document.getElementById("groupNameInput");
  const enteredName = (nameInp instanceof HTMLInputElement) ? nameInp.value.trim() : "";

  if (!contextTarget || contextTarget.groupIndex == null) {
    const newGroup = { name: enteredName || "New Group", teamMembers: [], projects: [] };
    groups.push(newGroup);
    const gi = groups.length - 1;
    addLogEntry("", "group-create", { groupIndex: gi, name: newGroup.name });
    addLogEntry(newGroup.name, "group-create", { groupIndex: gi, name: newGroup.name });
  } else {
    const idx = contextTarget.groupIndex;
    groups[idx].name = enteredName || groups[idx].name;
  }

  saveData();   // ✅ auto-save
  closeGroupModal();
  render();
}


function deleteGroup() {
  if (!contextTarget || contextTarget.groupIndex == null) {
    alert("No group selected to delete.");
    return;
  }
  if (confirm("⚠️ Are you sure you want to DELETE this group? This will also delete all its projects.")) {
    const idx = contextTarget.groupIndex;
    const removed = groups[idx];
    addLogEntry("", "group-delete", { groupIndex: idx, name: removed?.name || "" });
    addLogEntry(removed?.name || "", "group-delete", { groupIndex: idx, name: removed?.name || "" });
    groups.splice(idx, 1);
    saveData();   // ✅ auto-save
    closeGroupModal();
    render();
  }
}



// --- Wire Group Modal Buttons ---
(function wireGroupModalButtons() {
  const btnSave   = document.getElementById("btnGroupSave");
  const btnClose  = document.getElementById("btnGroupClose");
  const btnDelete = document.getElementById("btnGroupDelete");
  
  const btnEditTeam = document.getElementById("btnGroupEditTeam");
  const btnNewProj = document.getElementById("btnGroupNewProject");
  if (btnNewProj) btnNewProj.onclick = () => newProjectFromGroup();
  if (btnEditTeam) btnEditTeam.onclick = () => openTeamFromGroup();
  if (btnSave)   btnSave.onclick   = saveGroup;
  if (btnClose)  btnClose.onclick  = () => closeGroupModal();
  if (btnDelete) btnDelete.onclick = deleteGroup;
  
  const btnApplyName = document.getElementById("btnApplyGroupName");
  if (btnApplyName) {
    btnApplyName.onclick = () => {
      if (!contextTarget || contextTarget.groupIndex == null) return;

      const gi = contextTarget.groupIndex;
      const nameInp = document.getElementById("groupNameInput");

      if (nameInp instanceof HTMLInputElement) {
        const newName = nameInp.value.trim();
        if (newName) {
          groups[gi].name = newName;

          // Log group edit
          addLogEntry(groups[gi].name,"group-edit", {
            groupIndex: gi,
            name: newName
          });
          saveData();
          render();
        }
      }
    };
  }
})();

  /* ===================== TEAM MODAL (OFFLINE) ===================== */
function renderTeamList(gi) {
  const list = document.getElementById('memberList');
  if (!list) return;
  list.innerHTML = '';

  const g = groups[gi];
  (g.teamMembers || []).forEach((m, idx) => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.gap = '8px';

    const who = document.createElement('span');
    who.textContent = `${m.role || ''} ${m.name || ''}`.trim();
    row.appendChild(who);

    const edit = document.createElement('button');
    edit.textContent = 'Edit';
    edit.addEventListener('click', () => {
  const roleInp = document.getElementById('roleInput');
  const nameInp = document.getElementById('memberName');
  if (roleInp instanceof HTMLInputElement) roleInp.value = m.role;
  if (nameInp instanceof HTMLInputElement) nameInp.value = m.name;
  editingMemberIndex = idx;

  // Show Apply Edit, hide Add Member
  const btnSave = document.getElementById('btnTeamSave');
  const btnApply = document.getElementById('btnTeamApply');
  if (btnSave) btnSave.style.display = 'none';
  if (btnApply) btnApply.style.display = 'inline-block';
});

    row.appendChild(edit);

// --- Delete button ---
const del = document.createElement('button');
del.className = 'danger';
del.textContent = 'Delete';
del.addEventListener('click', () => {
  if (!confirm('Remove this team member?')) return;

  const removed = g.teamMembers[idx];  // ✅ correct array and index

  // ✅ Log team member removal
  addLogEntry(g.name, "team-remove", {
    groupIndex: gi,
    teamIndex: idx,
    name: removed?.name || ""
  });
  compileDailyLogs();
  g.teamMembers.splice(idx, 1);       // ✅ remove from correct array
  saveData();
  renderTeamList(gi); // re-render the team modal
  render();
});
row.appendChild(del);

    list.appendChild(row);
  });
}

function openTeamModal(gi) {
  contextTarget = { groupIndex: gi };
  const g = groups[gi];

  const roleInp = document.getElementById('roleInput');
  const nameInp = document.getElementById('memberName');
  if (roleInp) roleInp.value = '';
  if (nameInp) nameInp.value = '';

  renderTeamList(gi);
  openModal('teamModal');

  const saveBtn  = document.getElementById('btnTeamSave');
  const applyBtn = document.getElementById('btnTeamApply');
  const closeBtn = document.getElementById('btnTeamClose');

  if (saveBtn) {
    saveBtn.onclick = () => {
      const role = (roleInp instanceof HTMLInputElement && roleInp.value.trim())
        ? roleInp.value.trim()
        : 'MEMBER';
      const name = (nameInp instanceof HTMLInputElement && nameInp.value.trim())
        ? nameInp.value.trim()
        : '';
      if (!name) { alert('Enter a name.'); return; }

     (g.teamMembers = g.teamMembers || []).push({ role, name });
const newIdx = g.teamMembers.length - 1;

// ✅ Log team member addition
addLogEntry(g.name, "team-add", {
  groupIndex: gi,
  teamIndex: newIdx,
  role,
  name
});
compileDailyLogs();

saveData();
roleInp.value = '';
nameInp.value = '';
renderTeamList(gi);
render();

    };
  }

  if (applyBtn) {
    applyBtn.onclick = () => {
      const role = (roleInp instanceof HTMLInputElement && roleInp.value.trim())
        ? roleInp.value.trim()
        : 'MEMBER';
      const name = (nameInp instanceof HTMLInputElement && nameInp.value.trim())
        ? nameInp.value.trim()
        : '';
      if (!name) { alert('Enter a name.'); return; }

      if (editingMemberIndex != null) {
        g.teamMembers[editingMemberIndex] = { role, name };
        editingMemberIndex = null;
      }

      saveData();
      roleInp.value = '';
      nameInp.value = '';
      renderTeamList(gi);
      render();

      // Reset buttons
      if (saveBtn) saveBtn.style.display = 'inline-block';
      if (applyBtn) applyBtn.style.display = 'none';
    };
  }

  if (closeBtn) {
    if (closeBtn) closeBtn.onclick = () => closeModal('teamModal');
  }
}

function renderMilestoneList(gi, pi) {
  const holder = document.getElementById('milestoneList');
  if (!holder) return;
  holder.innerHTML = '';

  const g = groups[gi];
const p = g?.projects?.[pi];

  (p?.milestones || []).forEach((m, mi) => {
    const row = document.createElement('div');

    // --- Milestone label ---
    const label = document.createElement('span');
    const range = [];
    if (m.startDate)      range.push(m.startDate);
    if (m.completionDate) range.push(m.completionDate);
    const rangeText = range.length ? ` (${range.join(' → ')})` : (m.date ? ` (${m.date})` : '');
    label.textContent = `${m.label || 'Milestone'}${rangeText}`;
    row.appendChild(label);

    // --- Edit button ---
    const edit = document.createElement('button');
    edit.textContent = 'Edit';
    edit.addEventListener('click', () => openMilestoneModal(gi, pi, mi));
    row.appendChild(edit);

    // --- Status toggle button ---
    const toggle = document.createElement('button');
    const today = new Date();
    const dueDate = m.date ? parseLocalDate(m.date) : null;
    const isUpcoming = dueDate && today <= dueDate; // upcoming vs past-due

    function applyButtonStyle(status) {
      switch (status) {
        case 'incomplete': // upcoming
          toggle.textContent = 'Upcoming';
          toggle.style.background = 'orange';
          toggle.style.color = 'white';
          break;
        case 'overdue': // past due
          toggle.textContent = 'Overdue';
          toggle.style.background = 'red';
          toggle.style.color = 'white';
          break;
        case 'completed':
          toggle.textContent = 'Completed';
          toggle.style.background = 'limegreen';
          toggle.style.color = 'white';
          break;
        case 'completedLate':
          toggle.textContent = 'Completed Late';
          toggle.style.background =
            'repeating-linear-gradient(45deg, red, red 4px, limegreen 4px, limegreen 8px)';
          toggle.style.color = 'white';
          break;
      }
    }

    // default status if not set
    if (!m.status) {
      m.status = isUpcoming ? 'incomplete' : 'overdue';
    }

    applyButtonStyle(m.status);

// toggle behavior
toggle.addEventListener('click', () => {
  const oldStatus = m.status;

  if (isUpcoming) {
    m.status = (m.status === 'incomplete') ? 'completed' : 'incomplete';
  } else {
    if (m.status === 'overdue') {
      m.status = 'completed';
    } else if (m.status === 'completed') {
      m.status = 'completedLate';
    } else {
      m.status = 'overdue';
    }
  }

  // ✅ Add log entry for status change
  if (oldStatus !== m.status) {
    addLogEntry(g.name, "milestone-status-change", {
      groupIndex: gi,
      projectIndex: pi,
      milestoneIndex: mi,
      label: m.label || "",
      from: oldStatus,
      to: m.status
    });
    compileDailyLogs();
  }

  saveData();
  applyButtonStyle(m.status);
  render();
});


    row.appendChild(toggle);

    // --- Delete button ---
    const del = document.createElement('button');
    del.className = 'danger';
    del.textContent = 'Delete';
    del.addEventListener('click', () => {
      if (!confirm('Delete this milestone?')) return;
      p.milestones.splice(mi, 1);
      saveData();
      renderMilestoneList(gi, pi);
      render();
    });
    row.appendChild(del);

    holder.appendChild(row);
  });
}

  function openMilestoneModal(gi, pi, mi = null) {
    contextTarget = { groupIndex: gi, projectIndex: pi, milestoneIndex: mi };
    // Store currently edited milestone index in a data-* attr on the modal for simplicity
    const modal = document.getElementById('milestoneModal');
    if (!modal) return;
    modal.dataset.mi = (mi == null ? '' : String(mi));

    const g = groups[gi];
    const p = g?.projects?.[pi];
    const m = (mi == null) ? { label:'', startDate:'', completionDate:'' } : (p?.milestones?.[mi] || {});

    const nameInp  = document.getElementById('milestoneNameInput');
    const startInp = document.getElementById('milestoneStartDate');
    

    if (nameInp  instanceof HTMLInputElement)  nameInp.value  = m.label || '';
    if (startInp instanceof HTMLInputElement)  startInp.value = m.startDate || m.date || '';
    

    // Wire buttons (save/delete/close wired here; save logic in Section 7 will finalize)
    const btnSave  = document.getElementById('btnMsSave');
    const btnClose = document.getElementById('btnMsClose');
    const btnDel   = document.getElementById('btnMsDelete');

    if (btnSave) {
  btnSave.onclick = () => {
    const label = (nameInp instanceof HTMLInputElement) ? nameInp.value.trim() : '';
    const s     = (startInp instanceof HTMLInputElement) ? startInp.value : '';

    const payload = {
      label,
      date: s,
      startDate: s
    };

    if (!Array.isArray(p.milestones)) p.milestones = [];

    let idx = contextTarget.milestoneIndex;
if (idx == null || idx === '') {
  // --- New milestone ---
  p.milestones.push(payload);
  idx = p.milestones.length - 1;
  const newMs = p.milestones[idx];

  addLogEntry(g.name, "milestone-add", {
    groupIndex: gi,
    projectIndex: pi,
    milestoneIndex: idx,
    label: newMs.label || "",
    date: newMs.date || "",
    status: newMs.status || "incomplete"
  });
} else {
  // --- Editing an existing milestone ---
  p.milestones[idx] = payload;

  const savedMilestone = p.milestones[idx];
  addLogEntry(g.name,"milestone-edit", {
    groupIndex: gi,
    projectIndex: pi,
    milestoneIndex: idx,
    label: savedMilestone.label,
    status: savedMilestone.status,
    date: savedMilestone.date
  });
}


compileDailyLogs();
saveData();
renderMilestoneList(gi, pi);
render();
closeModal('milestoneModal');
  };
}

    if (btnClose) btnClose.onclick = () => closeModal('milestoneModal');

    openModal('milestoneModal');
  }

  /* ===================== PROJECT MODAL (OPEN/SAVE/DELETE) ===================== */
  function openProjectModal(gi, pi) {
    contextTarget = { groupIndex: gi, projectIndex: pi };
    const g = groups[gi];
    const p = (pi == null || pi === undefined) ? { name:'', startDate:'', completionDate:'', milestones:[] } : g.projects[pi];

    const nameInp = document.getElementById('projectNameInput');
    const start   = document.getElementById('projectStartDate');
    const comp    = document.getElementById('projectCompletionDate');

    if (nameInp instanceof HTMLInputElement) nameInp.value = p.name || '';
    if (start   instanceof HTMLInputElement) start.value   = p.startDate || '';
    if (comp    instanceof HTMLInputElement) comp.value    = p.completionDate || '';

    // Render milestones for this project
    renderMilestoneList(gi, (pi ?? g.projects.length));

    // Wire buttons
    const btnSave  = document.getElementById('btnProjSave');
    const btnClose = document.getElementById('btnProjClose');
    const btnDel   = document.getElementById('btnProjDelete');
    const btnAddMs = document.getElementById('btnProjAddMilestone');

          if (btnSave) {
       btnSave.onclick = () => {
  const payload = {
    name: (nameInp instanceof HTMLInputElement) ? (nameInp.value.trim() || 'Project') : 'Project',
    startDate: (start instanceof HTMLInputElement) ? (start.value || '') : '',
    completionDate: (comp instanceof HTMLInputElement) ? (comp.value || '') : '',
    milestones: Array.isArray(p.milestones) ? p.milestones : []
  };

  let projectIndex;

  if (pi == null || pi === undefined) {
    // New project
    g.projects.push(payload);
    projectIndex = g.projects.length - 1;

    addLogEntry(g.name, "project-create", {
      groupIndex: gi,
      projectIndex,
      ...payload
    });
} else {
  // --- Editing an existing project (DIFF + granular logs) ---
  var prev = JSON.parse(JSON.stringify(g.projects[pi] || {})); // snapshot before edit
  g.projects[pi] = JSON.parse(JSON.stringify(payload));
  projectIndex = pi;

  // 1) Name change
  if ((prev.name || "") !== (payload.name || "")) {
    addLogEntry(g.name, "project-name-change", {
      groupIndex: gi,
      projectIndex: pi,
      from: prev.name || "",
      to: payload.name || ""
    });
  }

  // 2) Start date change
  if ((prev.startDate || "") !== (payload.startDate || "")) {
    addLogEntry(g.name, "project-start-change", {
      groupIndex: gi,
      projectIndex: pi,
      projectName: p.name || "",
      from: prev.startDate || "",
      to: payload.startDate || ""
    });
  }

  // 3) End date change
  if ((prev.completionDate || "") !== (payload.completionDate || "")) {
    addLogEntry(g.name, "project-end-change", {
      groupIndex: gi,
      projectIndex: pi,
      projectName: p.name || "",
      from: prev.completionDate || "",
      to: payload.completionDate || ""
    });
  }

  // 4) Milestones: added / removed / changed (by label)
  var prevMs = Array.isArray(prev.milestones) ? prev.milestones : [];
  var nextMs = Array.isArray(payload.milestones) ? payload.milestones : [];

  function indexByLabel(list) {
    var m = {};
    for (var i = 0; i < list.length; i++) {
      var it = list[i] || {};
      var k = String(it.label || "").toLowerCase();
      if (k) m[k] = it;
    }
    return m;
  }

  var prevMap = indexByLabel(prevMs);
  var nextMap = indexByLabel(nextMs);

  // additions
  for (var k in nextMap) {
    if (!prevMap.hasOwnProperty(k)) {
      var add = nextMap[k];
      addLogEntry(g.name, "milestone-add", {
        groupIndex: gi,
        projectIndex: pi,
        label: add.label || "",
        date:  add.date || add.startDate || "",
        status: add.status || ""
      });
    }
  }

  // removals
  for (var k2 in prevMap) {
    if (!nextMap.hasOwnProperty(k2)) {
      var rem = prevMap[k2];
      addLogEntry(g.name, "milestone-remove", {
        groupIndex: gi,
        projectIndex: pi,
        label: rem.label || "",
        date:  rem.date || rem.startDate || "",
        status: rem.status || ""
      });
    }
  }

  // changes (same label; date or status differs)
  for (var k3 in nextMap) {
    if (prevMap.hasOwnProperty(k3)) {
      var oldM = prevMap[k3];
      var newM = nextMap[k3];
      var oldDate = oldM.date || oldM.startDate || "";
      var newDate = newM.date || newM.startDate || "";
      var oldStatus = oldM.status || "";
      var newStatus = newM.status || "";

      if (oldDate !== newDate || oldStatus !== newStatus) {
        addLogEntry(g.name, "milestone-change", {
          groupIndex: gi,
          projectIndex: pi,
          label: newM.label || "",
          from: { date: oldDate, status: oldStatus },
          to:   { date: newDate, status: newStatus }
        });
      }
    }
  }

  // If you rely on the Daily Log immediately, compile now (optional)
  compileDailyLogs();
}


  saveData();
  render();
  renderGroupProjectList(gi);
  closeModal("projectModal");
};
     
      }

        if (btnClose) btnClose.onclick = () => closeModal('projectModal');
    if (btnAddMs) btnAddMs.onclick = () => openMilestoneModal(gi, (pi ?? g.projects.length));

    openModal('projectModal');
  }
  /* ===================== MODAL MANAGER (FOCUS TRAP + ESC + BACKDROP) ===================== */
  
  const modalStack = [];
  let bodyScrollPrev = '';

  function getFocusable(root) {
    return Array.from(
      root.querySelectorAll(
        'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
      )
    ).filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
  }

  function trapFocus(modal) {
    const focusables = getFocusable(modal);
    if (!focusables.length) return () => {};
    const first = focusables[0];
    const last  = focusables[focusables.length - 1];

    function onKeyDown(e) {
      if (e.key === 'Escape') {
        e.stopPropagation();
        closeModal(modal.id);
        return;
      }
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault(); last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault(); first.focus();
        }
      }
    }

    modal.addEventListener('keydown', onKeyDown);
    return () => modal.removeEventListener('keydown', onKeyDown);
  }

  function openModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;

    // display + accessibility
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');

    // backdrop click to close (kept minimal; does not change layout)
    if (!modal.dataset.backdropBound) {
      modal.addEventListener('mousedown', (e) => {
        if (e.target === modal) closeModal(id);
      });
      modal.dataset.backdropBound = '1';
    }

    // lock body scroll on first modal
    if (modalStack.length === 0) {
      bodyScrollPrev = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
    }

    // focus trap + initial focus
    const release = trapFocus(modal);
    const toFocus = getFocusable(modal)[0] || modal;
    setTimeout(() => toFocus.focus({ preventScroll: true }), 0);

    modalStack.push({ id, release });
  }

  function closeModal(id) {
    // if no id provided, close top; else close that id
    let entryIndex = -1;
    if (id) entryIndex = modalStack.findIndex(m => m.id === id);
    if (entryIndex === -1) entryIndex = modalStack.length - 1;
    if (entryIndex < 0) return;

    const { id: targetId, release } = modalStack.splice(entryIndex, 1)[0];
    const modal = document.getElementById(targetId);
    if (!modal) return;

    // release focus trap
    try { release && release(); } catch {}

    // hide
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');

    // restore scroll when stack empty
    if (modalStack.length === 0) {
      document.body.style.overflow = bodyScrollPrev || '';
    }

    // refocus previous modal (if any)
    if (modalStack.length) {
      const top = modalStack[modalStack.length - 1];
      const topEl = document.getElementById(top.id);
      if (topEl) {
        const toFocus = getFocusable(topEl)[0] || topEl;
        toFocus.focus({ preventScroll: true });
      }
    }
  }
  /* ===================== VIEW-STATE (PER-PROJECT OFFSETS) ===================== */
  function loadViewState() {
    try {
      const raw = localStorage.getItem(VIEW_KEY);
      const parsed = raw ? JSON.parse(raw) : {};
      return (parsed && typeof parsed === 'object') ? parsed : {};
    } catch (e) {
      console.warn('ViewState parse failed:', e);
      return {};
    }
  }
  function saveViewState() {
    try { localStorage.setItem(VIEW_KEY, JSON.stringify(projectViewState)); }
    catch (e) { console.warn('ViewState save failed:', e); }
  }

  /* ===================== TOOLBAR WIRING (OFFLINE) ===================== */
  function wireToolbar() {
    const btnNewGroup = document.getElementById('btnNewGroup');
    const btnSave     = document.getElementById('btnSave');
    const btnLoad     = document.getElementById('btnLoad');
    const fileInput   = document.getElementById('jsonFileInput');


if (btnNewGroup) {
  btnNewGroup.onclick = () => {
    // Create a new group object with default values
    const newGroup = {
      name: "New Group",
      teamMembers: [],
      projects: []
    };

    // Add it to the list
    groups.push(newGroup);
    const gi = groups.length - 1;

      // Save and re-render the timeline
    saveData();
    render();
  };
}

}

/* ===================== BOOT / INIT ===================== */
(function init() {
  wireToolbar();

// NEW bootstrap using backend
(async () => {
  const ok = await loadFromServer();
  if (!ok) {
    console.warn("Starting with empty dataset");
    groups = [];
  }
  render();
  });

  // Force logout when window/tab is closed or refreshed
  const clearSessionOnExit = () => {
    try {
      localStorage.removeItem("bm-currentUser"); // actual saved user
      localStorage.removeItem("loggedInUser");
      localStorage.removeItem("userRole");
    } catch (_) {}
  };
  window.addEventListener("pagehide", clearSessionOnExit, { capture: true });
  window.addEventListener("beforeunload", clearSessionOnExit, { capture: true });

    // --- REPORT MODE (single-group compiled view) ---
  const m = window.location.hash.match(/^#?report=(\d+)$/);
  if (m) {
    const giFromHash = parseInt(m[1], 10);
    const g = (Array.isArray(groups) && groups[giFromHash]) ? groups[giFromHash] : null;

    const reportShell = document.getElementById("reportPage");
    const reportContent = document.getElementById("reportContent");
    const tracker = document.getElementById("trackerWrapper");

    if (g && reportShell && reportContent) {
      showReportPage(g); // fills #reportContent and shows #reportPage
      if (tracker) tracker.style.display = "none";
    } else {
      if (reportContent) {
        reportContent.innerHTML = "<p><em>Group not found.</em></p>";
      }
      if (reportShell) reportShell.style.display = "block";
      if (tracker) tracker.style.display = "none";
    }
    return;  // skip timeline render in report mode
  }

    render();
  })();

// ===================== TIMELINE ZOOM (MOUSE WHEEL) =====================
const wrapper = document.getElementById("trackerWrapper");
if (wrapper) {
  wrapper.addEventListener("wheel", (e) => {
    if (e.ctrlKey) return; // let ctrl+wheel for browser zoom pass through
    e.preventDefault();

    // Figure out which group card the mouse is over
    const r = wrapper.getBoundingClientRect();
    const x = e.clientX - r.left + wrapper.scrollLeft;
    const y = e.clientY - r.top  + wrapper.scrollTop;

    let target = null;
for (let i = 0; i < projectBarRegions.length; i++) {
  const reg = projectBarRegions[i];
  if (x >= reg.x1 && x <= reg.x2 && y >= reg.y1 && y <= reg.y2) {
    target = reg;
    break;
  }
}

    if (!target) return; // not hovering a project

    const key = `${target.gi}-${target.pi}`;
    const curZoom = projectZoomLevels[key] || 15;
    const totalDays = Math.max(1, Math.ceil(
      (Date.UTC(
        groups[target.gi].projects[target.pi].completionDate.split("-")[0],
        groups[target.gi].projects[target.pi].completionDate.split("-")[1] - 1,
        groups[target.gi].projects[target.pi].completionDate.split("-")[2]
      ) -
      Date.UTC(
        groups[target.gi].projects[target.pi].startDate.split("-")[0],
        groups[target.gi].projects[target.pi].startDate.split("-")[1] - 1,
        groups[target.gi].projects[target.pi].startDate.split("-")[2]
      )
    ) / DAY_MS));

    const oldViewport = Math.min(totalDays, curZoom);
    const oldOffset = getOffset(target.gi, target.pi);

    // fraction of cursor along the bar (0 = left, 1 = right)
    const barWidth = target.x2 - target.x1;
    const cursorFrac = (x - target.x1) / barWidth;

    // which day under cursor before zoom
    const cursorDay = oldOffset + Math.round(cursorFrac * oldViewport);

    // apply zoom in/out
    let newZoom = curZoom;
    if (e.deltaY < 0) newZoom = Math.max(15, curZoom - 1);
    else newZoom = Math.min(90, curZoom + 1);
    projectZoomLevels[key] = newZoom;

    // compute new offset so cursorDay stays under cursorFrac
    const newViewport = Math.min(totalDays, newZoom);
    let newOffset = cursorDay - Math.round(cursorFrac * newViewport);
    newOffset = Math.max(0, Math.min(totalDays - newViewport, newOffset));
    setOffset(target.gi, target.pi, newOffset);

    render();
  }, { passive: false });
}

  document.addEventListener('contextmenu', (e) => e.preventDefault(), { passive: false });

  /* ===================== LOGIN / USER PROFILE ===================== */
// Restore session if it exists
let loggedInUser = localStorage.getItem("loggedInUser");
let userRole = localStorage.getItem("userRole");

// Load users from localStorage, or use default admin
let users = JSON.parse(localStorage.getItem("users")) || [
  { username: "admin", password: "admin123", role: "admin" }
];

// Helper: save users back to localStorage
function saveUsers() {
  localStorage.setItem("users", JSON.stringify(users));
}

function handleLogin() {
  const user = document.getElementById('loginUsername')?.value.trim();
  const pass = document.getElementById('loginPassword')?.value;

  if (!user || !pass) {
    alert("Please enter both username and password.");
    return;
  }

  // Look up in the users array
  const found = users.find(u => u.username === user && u.password === pass);
  if (!found) {
    alert("Invalid credentials.");

    // ✅ Log invalid login attempt
    addLogEntry("", "invalid-login", {
      attemptedUser: user || "(blank)"
    });

    return;
  }

  // ✅ Only after a valid login: set session
  loggedInUser = found.username;
  userRole     = found.role;
  localStorage.setItem("loggedInUser", loggedInUser);
  localStorage.setItem("userRole", userRole);

  currentUser = { username: loggedInUser, role: userRole };
  localStorage.setItem("bm-currentUser", JSON.stringify(currentUser));

  // ✅ Force creation of today’s daily log bucket right on login
  compileDailyLogs();

  // ✅ Log successful login
  addLogEntry("", "login", { username: loggedInUser, role: userRole });


  // Assign session values
  loggedInUser = found.username;
  userRole = found.role;

  // Save session to localStorage
  localStorage.setItem("loggedInUser", loggedInUser);
  localStorage.setItem("userRole", userRole);
  currentUser = { username: loggedInUser, role: userRole };
  localStorage.setItem("bm-currentUser", JSON.stringify(currentUser));


  // Update UI
  const btnLogin = document.getElementById('btnLogin');
  if (btnLogin) {
    btnLogin.textContent = "Log out";
    btnLogin.onclick = handleLogout;   // ✅ switch handler immediately
  }

  const btnEditUser = document.getElementById('btnEditUser');
  if (btnEditUser) {
    btnEditUser.style.display = (userRole === "admin") ? "inline-block" : "none";
  }

  applyPermissions();
  render();                             // ✅ refresh UI instantly

  document.getElementById("screenOverlay").style.display = "none";
  closeModal('loginModal');
}

  function handleLogout() {
    if (currentUser) {
    addLogEntry("", "logout", {
      username: currentUser.username,
      role: currentUser.role
    });
  }
    loggedInUser = null;
    userRole = null;
    currentUser = null;

    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("userRole");
    localStorage.removeItem("bm-currentUser");


  const btnLogin = document.getElementById('btnLogin');
  if (btnLogin) btnLogin.textContent = "Login";

  const btnEditUser = document.getElementById('btnEditUser');
  if (btnEditUser) btnEditUser.style.display = "none";

  // Clear login modal fields so they’re always blank
  const userInp = document.getElementById("loginUsername");
  const passInp = document.getElementById("loginPassword");
  if (userInp) userInp.value = "";
  if (passInp) passInp.value = "";

  // NEW: re-apply non-admin/user permissions immediately
  applyPermissions();

  const overlay = document.getElementById("screenOverlay");
  if (overlay) overlay.style.display = "block";
  openModal("loginModal");
}

function applyPermissions() {
  const restrictedButtons = ["btnNewGroup", "btnSave", "btnLoad", "btnEditUser"];
  const isAdmin = (userRole === "admin");
  const isLoggedOut = (!loggedInUser);

  // Hide/disable top bar buttons unless admin
  restrictedButtons.forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if (isAdmin) {
      el.style.display = "inline-block";
      el.disabled = false;
    } else {
      el.style.display = "none";   // completely hidden
      el.disabled = true;          // extra safety
    }
  });

// Disable all modal controls unless admin
const modals = ["groupModal", "projectModal", "milestoneModal", "teamModal", "editUserModal"];
modals.forEach(id => {
  const modal = document.getElementById(id);
  if (!modal) return;

  const buttons = modal.querySelectorAll("button");
  buttons.forEach(btn => {
    if (btn.id !== "btnLogin" && btn.id !== "btnLoginSubmit" && btn.id !== "btnLoginCancel") {
      btn.disabled = !isAdmin;   // <--- only disable if not admin
    }
  });

  const inputs = modal.querySelectorAll("input, select, textarea");
  inputs.forEach(inp => {
    inp.disabled = !isAdmin;     // <--- only disable if not admin
  });
});

  // Disable clickable group labels in the timeline
  const labels = document.querySelectorAll(".clickable");
  labels.forEach(lbl => {
    if (!isAdmin) {
      lbl.classList.remove("clickable");
      lbl.style.pointerEvents = "none";
      lbl.style.opacity = "0.6";
    } else {
      lbl.classList.add("clickable");
      lbl.style.pointerEvents = "auto";
      lbl.style.opacity = "1";
    }
  });
}

function wireLoginSystem() {
  const btnLogin = document.getElementById('btnLogin');
  const btnSubmit = document.getElementById('btnLoginSubmit');
  const btnCancel = document.getElementById('btnLoginCancel');

  if (btnLogin) {
    btnLogin.onclick = () => {
      if (loggedInUser) {
        handleLogout();
      } else {

      // explicitly open login modal
        openModal('loginModal');
      }
    };
  }

  if (btnSubmit) {
    btnSubmit.onclick = () => handleLogin();
  }

  if (btnCancel) {
    btnCancel.onclick = () => closeModal('loginModal');
  }
}

document.addEventListener("DOMContentLoaded", () => {
  if (loggedInUser && userRole) {
    const btnLogin = document.getElementById('btnLogin');
    if (btnLogin) btnLogin.textContent = "Log out";

    const btnEditUser = document.getElementById('btnEditUser');
    if (btnEditUser) {
      btnEditUser.style.display = (userRole === "admin") ? "inline-block" : "none";
    }

    document.getElementById("screenOverlay").style.display = "none";
  } else {
    document.getElementById("screenOverlay").style.display = "block";
    openModal("loginModal");
  }

  // ✅ Always enforce permissions regardless of login state
  applyPermissions();

  wireLoginSystem();
  renderUserList();
});

/* ===================== EDIT USER MODAL ===================== */
function renderUserList() {
  const userList = document.getElementById('userList');
  if (!userList) return;
  userList.innerHTML = "";

  users.forEach((u, idx) => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.style.marginBottom = "0.5rem";

    const info = document.createElement("span");
    info.textContent = `${u.username} (${u.role})`;
    row.appendChild(info);

    const actions = document.createElement("div");

    // Edit button
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.style.marginRight = "5px";
    editBtn.onclick = () => {
      document.getElementById('newUsername').value = u.username;
      document.getElementById('newPassword').value = u.password;
      document.getElementById('newRole').value = u.role;

      const btnAdd = document.getElementById('btnAddUser');
      btnAdd.textContent = "Save Changes";
      btnAdd.onclick = () => {
        const name = document.getElementById('newUsername').value.trim();
        const pass = document.getElementById('newPassword').value.trim();
        const role = document.getElementById('newRole').value;

        if (!name || !pass) {
          alert("Enter both username and password.");
          return;
        }
        users[idx] = { username: name, password: pass, role };
        saveUsers();
        btnAdd.textContent = "Add User";
        btnAdd.onclick = () => addUser();

        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';
        renderUserList();
      };
    };
    actions.appendChild(editBtn);

    // Remove button (not for default admin)
    if (u.username !== "admin") {
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => {
        users.splice(idx, 1);
        saveUsers();
        renderUserList();
      };
      actions.appendChild(removeBtn);
    }

    row.appendChild(actions);
    userList.appendChild(row);
  });
}

function openEditUserModal() {
  renderUserList();
  openModal('editUserModal');
}

function addUser() {
  const name = document.getElementById('newUsername')?.value.trim();
  const pass = document.getElementById('newPassword')?.value.trim();
  const role = document.getElementById('newRole')?.value;

  if (!name || !pass) {
    alert("Enter both username and password.");
    return;
  }
  if (users.find(u => u.username === name)) {
    alert("User already exists.");
    return;
  }
  users.push({ username: name, password: pass, role });
  saveUsers();
  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  renderUserList();
}

(function wireEditUserButton() {
  const btnEditUser = document.getElementById('btnEditUser');
  const btnClose = document.getElementById('btnCloseEditUser');
  const btnAdd = document.getElementById('btnAddUser');

  if (btnEditUser) btnEditUser.onclick = () => openEditUserModal();
  if (btnClose) btnClose.onclick = () => closeModal('editUserModal');
  if (btnAdd) btnAdd.onclick = () => addUser();

  document.addEventListener("DOMContentLoaded", () => {
  if (loggedInUser && userRole) {
    const btnLogin = document.getElementById('btnLogin');
    if (btnLogin) btnLogin.textContent = "Log out";

    const btnEditUser = document.getElementById('btnEditUser');
    if (btnEditUser) {
      btnEditUser.style.display = (userRole === "admin") ? "inline-block" : "none";
    }

    applyPermissions();
  }
  renderUserList();
});

})();

function showReportPage(group) {
  let html = `
    <h2>${group.name}</h2>
    <ul>
      ${(group.teamMembers || [])
        .map(m => `<li><strong>${m.role}</strong>: ${m.name}</li>`)
        .join("")}
    </ul>
    <div>
      ${(group.projects || [])
        .map(p => {
          const milestones = (p.milestones || [])
            .map(m => {
              const today = new Date();
              let dateText = m.date || m.startDate || "";
              let status = m.status || "";
              let diffText = "";

              if (dateText) {
                const dueDate = parseLocalDate(dateText);

                // Normalize dates to calendar day only
                const toYMD = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const DAY_MS = 24 * 60 * 60 * 1000;
                const diffDays = (a, b) => Math.round((toYMD(a) - toYMD(b)) / DAY_MS);

                let delta = 0;

                if (m.status === "completed") {
                  // 🟢 Green: 0 if on/after due, negative if early
                  const completed = m.completedOn ? parseLocalDate(m.completedOn) : today;
                  const d = diffDays(completed, dueDate);
                  delta = d < 0 ? d : 0;
                  diffText = (delta !== 0) ? String(delta) : "0";
                } else if (m.status === "completedLate") {
                  // Striped: positive if completed after due date
                  const completed = m.completedOn ? parseLocalDate(m.completedOn) : today;
                  const d = diffDays(completed, dueDate);
                  delta = d > 0 ? d : 0;
                  diffText = (delta > 0 ? '+' : '') + String(delta);
                } else {
                  // Incomplete → compare today vs due
                  const d = diffDays(today, dueDate);
                  if (d === 0) {
                    diffText = "0"; // due today
                  } else {
                    diffText = (d > 0 ? '+' : '') + String(d);
                  }
                }
              }

                const statusLabels = {
                incomplete: "In Progress",
                overdue: "In Progress, Past Due",
                completed: "Complete, On-Time/Early",
                completedLate: "Complete, Past due"
              };

              return `
                <tr>
                  <td>${m.label || "Milestone"}</td>
                  <td>${dateText || "—"}</td>
                  <td>${statusLabels[m.status] || m.status || "—"}</td>
                  <td>${diffText}</td>
                </tr>`;
            })
            .join("");

          return `
            <div style="margin-bottom:1.5rem;">
              <h4>${p.name || "Untitled Project"}</h4>
              <p><strong>Start:</strong> ${p.startDate || "—"} 
                 &nbsp; <strong>Completion:</strong> ${p.completionDate || "—"}</p>
              ${
                milestones
                  ? `<table border="1" cellpadding="4" cellspacing="0" style="border-collapse:collapse; margin-top:0.5rem;">
                       <thead>
                          <tr>
                            <th style="width:20%;">Project</th>
                            <th style="width:15%;">Due Date</th>
                            <th style="width:15%;">Status</th>
                            <th style="width:15%;">Δ</th>   <!-- or "Days" if you prefer -->
                          </tr>
                        </thead>
                       <tbody>${milestones}</tbody>
                     </table>`
                  : "<p><em>No milestones</em></p>"
              }
            </div>`;
        })
        .join("")}
    </div>
  `;

  return html;
}

  (g.projects || []).forEach(p => {
    html += `
      <div style="margin-bottom: 1.5rem;">
        <strong>${p.name || "Untitled Project"}</strong><br>
        ${p.startDate || "?"} → ${p.completionDate || "?"}
        <table border="1" cellspacing="0" cellpadding="4" style="margin-top:5px; border-collapse:collapse; width:100%;">
          <tr><th>Milestone</th><th>Due Date</th><th>Status</th><th>Δ</th></tr>
          ${(p.milestones || []).map(ms => {
            let deltaText = "—";

            if (ms.date) {
              const now = new Date();
              const due = endOfDay(new Date(ms.date));
              const msDiff = due - now;

              if (ms.status === "incomplete") {
                if (now <= due) {
                  const daysRemaining = Math.floor(msDiff / (1000*60*60*24));
                  if (daysRemaining >= 1) {
                    deltaText = `${daysRemaining} days remaining`;
                  } else {
                    const hoursRemaining = Math.floor(msDiff / (1000*60*60));
                    deltaText = `${hoursRemaining} hours remaining`;
                  }
                }
              } else if (ms.status === "overdue") {
                if (now > due) {
                  const overdueDays = Math.floor((now - due) / (1000*60*60*24));
                  deltaText = `${overdueDays} days overdue`;
                }
              } else if (ms.status === "completed") {
                deltaText = "0 days";
              } else if (ms.status === "completedLate") {
                if (now > due) {
                  const lateDays = Math.floor((now - due) / (1000*60*60*24));
                  deltaText = `${lateDays} days late`;
                }
              }
            }

            return `
              <tr>
                <td>${ms.label || "Milestone"}</td>
                <td>${ms.date || ""}</td>
                <td>${ms.status || "incomplete"}</td>
                <td>${deltaText}</td>
              </tr>
            `;
          }).join("")}
        </table>
      </div>
    `;
  });

  const reportContent = document.getElementById("reportContent");
  if (reportContent) reportContent.innerHTML = html;

  document.getElementById("trackerWrapper").style.display = "none";
  document.getElementById("reportPage").style.display = "block";

</script>

<div id="reportPage" style="display:none; padding:20px;">
 <div id="reportContent"></div>
  <br>
  <button onclick="goBack()">⬅ Back</button>
</div>
</body>
</html>

